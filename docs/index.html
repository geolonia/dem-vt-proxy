<!DOCTYPE html>
<html>

<head>
  <title>GSI-DEM Vector</title>
  <style>
    html,
    body,
    #map {
      height: 100vh;
      width: 100vw;
      padding: 0;
      margin: 0;
      position: relative;
    }
    #hover-stats {
      position: absolute;
      top: 0;
      left: 0;
      background-color: #fff;
      padding: 4px 10px;
    }
  </style>
</head>

<body>
  <div id="map" data-gesture-handling="off" data-lat="35.3528" data-lng="138.7807" data-zoom="10" data-pitch="60" data-marker="off" data-style="./style.json" data-hash="on"></div>
  <div id="hover-stats">
    <div id="current-pos"></div>
    <div id="current-alt"></div>
  </div>

  <script type="text/javascript" src="https://cdn.geolonia.com/v1/embed?geolonia-api-key=YOUR-API-KEY"></script>
  <script type="module">
    import tilebelt from "./tilebelt.js";

    const map = new geolonia.Map('#map');
    window._mainMap = map;
    let hoveredStateId = null;
    const currentPos = document.getElementById('current-pos'),
          currentAlt = document.getElementById('current-alt');
    map.on('load', function () {
      const mapEl = document.getElementById('map');
      let hovered = [];
      mapEl.addEventListener('mousemove', function(e) {
        e.point = new mapboxgl.Point(e.clientX, e.clientY);
        const features = map.queryRenderedFeatures(e.point, {layers: ['dem-extrusion']});
        for (const feature of hovered) {
          map.setFeatureState(feature, {
            'hover': false,
          });
        }

        const seen = {};
        hovered = features;
        let i = 0;
        for (const feature of hovered) {
          if (seen[feature.id]) continue;

          seen[feature.id] = true;
          map.setFeatureState(feature, {
            'hover': i === 0,
          });
          i++;
        }

        const currentFeature = features[0];
        if (currentFeature) {
          const props = currentFeature.properties;
          currentPos.innerText = `${props.z}/${props.f}/${props.x}/${props.y}`;
          currentAlt.innerText = `${props.ele / 100}m`;
        }
      });

      let startTile = undefined;
      let endTile = undefined;
      mapEl.addEventListener('click', function(e) {
        e.point = new mapboxgl.Point(e.clientX, e.clientY);
        const features = map.queryRenderedFeatures(e.point, {layers: ['dem-extrusion']});
        const feature = features[0];
        if (feature) {
          const props = feature.properties;
          console.log(props);

          const fcf = [];
          if (!startTile) startTile = props;
          else if (startTile && !endTile) endTile = props;
          else if (startTile && endTile) {
            endTile = undefined;
            startTile = props;
          }

          if (startTile) {
            fcf.push({
              id: "1",
              type: "Feature",
              geometry: tilebelt.tileToGeoJSON([startTile.x, startTile.y, startTile.z]),
              properties: {
                kind: "start",
                ...startTile
              }
            });
          }
          if (endTile) {
            fcf.push({
              id: "2",
              type: "Feature",
              geometry: tilebelt.tileToGeoJSON([endTile.x, endTile.y, endTile.z]),
              properties: {
                kind: "end",
                ...endTile
              }
            });
          }
          console.log(fcf);
          map.getSource('th').setData({
            type: "FeatureCollection",
            features: fcf,
          })
        }
      });
    });
  </script>
</body>

</html>
